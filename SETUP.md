# IPO Automation System - Setup Guide

## Overview

This is a full-stack IPO automation system that combines:
- **Frontend**: Vercel/Next.js application for CSV upload and log monitoring
- **Backend**: GitHub Actions workflow that runs Python Playwright automation
- **Automation**: Python script with Playwright for browser-based IPO applications

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    User's Browser                           │
│  (Landing Page → CSV Upload → View Logs via Polling)       │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
        ┌────────────────────────────┐
        │   Vercel/Next.js Frontend   │
        │  - CSV Upload Form          │
        │  - Data Preview Table       │
        │  - Apply IPO Button         │
        │  - Live Log Console         │
        └────┬───────────────┬────────┘
             │               │
             │ Triggers      │ Polls
             ▼               ▼
    ┌──────────────────┐  ┌──────────────────┐
    │ GitHub Actions   │  │ Polling API      │
    │ Workflow         │  │ (/api/fetch-logs)│
    │ - Receives CSV   │  │ - Fetches from   │
    │ - Runs apply.py  │  │   GitHub         │
    │ - Saves logs     │  │   Artifacts      │
    │ - Uploads        │  └──────────────────┘
    │   artifact       │
    └─────────┬────────┘
              │
              ▼
    ┌──────────────────────────┐
    │  GitHub Artifacts        │
    │  (log-[apply_id].zip)    │
    └──────────────────────────┘
```

## Prerequisites

1. **GitHub Repository**: Your code must be on GitHub
2. **GitHub Token**: Create a Personal Access Token (PAT) with workflow permissions
3. **Vercel Account**: Deploy frontend to Vercel
4. **Node.js/npm**: For local development

## Setup Steps

### 1. Environment Variables

Set these environment variables in your Vercel project:

```
GITHUB_TOKEN=ghp_xxxxxxxxxxxxxxxxxxxxx  # Your GitHub Personal Access Token
GITHUB_REPOSITORY=owner/repo-name       # Your GitHub repository (e.g., user/ipo-automation)
```

**To create a GitHub PAT:**
1. Go to GitHub Settings → Developer settings → Personal access tokens
2. Create new token with scopes: `repo`, `workflow`
3. Copy the token and add to Vercel

### 2. Push Code to GitHub

```bash
git add .
git commit -m "Initial IPO automation setup"
git push origin main
```

Ensure the workflow file is at: `.github/workflows/ipo-automation.yml`

### 3. Deploy Frontend to Vercel

```bash
# Option 1: Using Vercel CLI
vercel

# Option 2: Connect GitHub repo at vercel.com
# - Import project
# - Add environment variables
- Deploy
```

### 4. Customize Python Script

The `scripts/apply.py` contains TODO comments for customization:

**Update these sections with your actual IPO portal:**

```python
# 1. Login URL and selectors
login_url = "https://your-ipo-portal.com/login"
# await self.page.fill("input#username", username)
# await self.page.fill("input#password", password)

# 2. DP selection logic
# await self.page.click("select#dp-selector")

# 3. Form field selectors for Step 1 & Step 2
# await self.page.fill("input#units", units)

# 4. Toast message selector
# await self.page.wait_for_selector(".toast--success")

# 5. Logout logic
# await self.page.click("button#logout")
```

**Key customization points:**
- Replace placeholder URLs with actual IPO portal URLs
- Update CSS/XPath selectors to match your portal's HTML
- Adjust form filling logic for Step 1 and Step 2
- Customize toast message verification
- Add any additional validation or conditional logic needed

### 5. Test the System

1. **Upload CSV**
   - Go to your Vercel deployment
   - Upload a CSV file with the required columns:
     ```csv
     name,dp,username,password,pin,crn,units
     basanta,13700,73058,password123,1234,12345678,100
     ```

2. **Click "Apply IPO"**
   - A random `apply_id` is generated
   - GitHub Actions workflow is triggered
   - Check the logs polling in the frontend

3. **Monitor Logs**
   - Logs update every 5 seconds
   - Shows workflow execution status
   - Download or copy logs when complete

## CSV File Format

**Required columns (exact order):**
```
name,dp,username,password,pin,crn,units
```

**Example:**
```csv
name,dp,username,password,pin,crn,units
basanta,13700,73058,password123,1234,12345678,100
rajesh,13700,73059,password456,5678,87654321,50
```

The frontend template provides a downloadable template matching this format.

## GitHub Actions Workflow Details

**Workflow file**: `.github/workflows/ipo-automation.yml`

**Inputs:**
- `apply_id`: Unique ID for the run (generated by frontend)
- `csv_data`: CSV data as JSON string

**Steps:**
1. Checkout code
2. Setup Python 3.11
3. Install dependencies (playwright, pydantic)
4. Install Playwright browsers
5. Run `scripts/apply.py`
6. Upload logs as artifact named `log-[apply_id]`
7. Retain artifact for 7 days

## API Endpoints

### POST /api/trigger-workflow
Triggers the GitHub Actions workflow.

**Request:**
```json
{
  "apply_id": "apply_1704067200000_abc123xyz",
  "csv_data": [
    {
      "name": "basanta",
      "dp": "13700",
      "username": "73058",
      "password": "password123",
      "pin": "1234",
      "crn": "12345678",
      "units": "100"
    }
  ]
}
```

**Response:**
```json
{
  "success": true,
  "message": "Workflow triggered successfully",
  "apply_id": "apply_1704067200000_abc123xyz"
}
```

### GET /api/fetch-logs?apply_id=apply_1704067200000_abc123xyz
Fetches logs from GitHub Actions artifact.

**Response (while processing):**
```json
{
  "error": "Logs not available yet"
}
```

**Response (after completion):**
```json
{
  "logs": "2024-01-01 12:00:00 - INFO - IPO AUTOMATION BOT STARTED\n...",
  "apply_id": "apply_1704067200000_abc123xyz"
}
```

## Frontend Components

- **`/app/page.tsx`**: Main landing page and layout
- **`/components/csv-upload-form.tsx`**: CSV file upload with validation
- **`/components/csv-table.tsx`**: Display CSV data (hides password/pin)
- **`/components/log-console.tsx`**: Live log display with polling

## Python Script Structure

**`/scripts/apply.py`**

Main classes:
- `IPOAutomationBot`: Handles browser automation workflow
- Methods:
  - `login()`: Authenticate user
  - `select_dp()`: Choose Depository Participant
  - `fill_ipo_form_step1()`: First form section
  - `fill_ipo_form_step2()`: Second form section
  - `verify_toast_message()`: Confirm success
  - `logout()`: End session
  - `process_account()`: Execute full workflow per account

Logging:
- All actions logged to `logs/ipo-application.log`
- Logs also streamed to console
- GitHub Actions uploads artifact automatically

## Troubleshooting

### Workflow not triggering
- Check `GITHUB_TOKEN` is set correctly in Vercel
- Verify workflow file is at `.github/workflows/ipo-automation.yml`
- Check GitHub token has `workflow` scope permission

### Logs not fetching
- Ensure GitHub token is valid and has artifact access
- Check if workflow completed (may take time)
- Look at browser console for API errors

### Python script errors
- Check script syntax: `python -m py_compile scripts/apply.py`
- Verify Playwright selectors match your portal
- Check `logs/ipo-application.log` for detailed errors

### CSV upload issues
- Ensure CSV has exact columns in order
- No extra spaces in column headers
- File is saved as `.csv` (not `.xlsx` or others)

## Security Considerations

1. **Never commit credentials**: CSV with passwords is only stored in logs (artifact)
2. **GitHub Token**: Use minimal scope token (workflow + repo)
3. **Log retention**: Artifacts auto-delete after 7 days
4. **HTTPS only**: Always deploy frontend with HTTPS (Vercel provides this)
5. **API Protection**: Consider adding authentication to API endpoints if deployed publicly

## Performance Notes

- Playwright headless browser: ~30-60 seconds per account
- Polling interval: 5 seconds (adjustable in `log-console.tsx`)
- Max 30 minute timeout per workflow (adjustable in `.yml`)
- Delay between accounts: 2 seconds (adjustable in `apply.py`)

## Next Steps

1. Customize `scripts/apply.py` for your IPO portal
2. Test with a single account first
3. Verify logs are being captured correctly
4. Scale to full batch once working
5. Consider adding error notifications (Slack, email, etc.)

## Support

For issues:
1. Check GitHub Actions logs in your repository
2. Check Vercel logs in your project dashboard
3. Review `logs/ipo-application.log` in artifacts
4. Check browser console for frontend errors
